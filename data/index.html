<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- <link rel="stylesheet" href="./index.css"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h3>HTML servido desde un servidor de Rust</h3>
    <input type="button" value="connect" onclick="connect()">
    <br>
    <p id="data"></p>
</body>
<script>
    let info = document.getElementById("data");

    const pc = new RTCPeerConnection();
    peer_states(pc);

    function peer_states(pc = new RTCPeerConnection){
        pc.onconnectionstatechange = ()=>{
            console.log("peer: ",pc.connectionState)
        }

        pc.onicegatheringstatechange = event =>{
            console.log(pc.iceGatheringState)
        }
    }

    async function connect_peers(pc = new RTCPeerConnection, offer ){
        await pc.setRemoteDescription(offer);
        let answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        // console.log(pc.localDescription)

        return new Promise((res,rej)=>{
            if(pc.iceGatheringState =="complete"){
                let answer_sdp = JSON.stringify(pc.localDescription)
                res(answer_sdp)
            }else{
                pc.onicegatheringstatechange = ()=>{
                    console.log(pc.iceGatheringState);
                    if (pc.iceGatheringState =="complete"){
                        let answer_sdp = JSON.stringify(pc.localDescription);
                        res(answer_sdp)
                    }
                }
            }
        })
    }

    function connect(){
        let socket = new WebSocket("ws://192.168.1.41:3000/connect");

        socket.onclose = ()=>{
            console.log("socket cerrado")
        }

        socket.onopen = ()=>{
            info.innerHTML = socket.readyState + " " + socket.url;
        }

        socket.onmessage = async event => {
            let data = JSON.parse(event.data)

            if (data.type === "offer"){
                connect_peers(pc, data)
                    .then(answer => {
                        socket.send(answer)
                    })
            }
            
            // console.log(data.sdp)
        }

        info.innerHTML = socket.readyState;   
    }

</script>
</html>